name: Build Debian Package

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # 每天UTC时间20:00运行 (对应北京时间次日凌晨4:00)

jobs:
  build-debian-package:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone smartdns repository
        run: |
          git clone https://github.com/pymumu/smartdns.git

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config

      - name: Build SmartDNS Debian package
        run: |
          cd smartdns
          chmod +x package/build-pkg.sh
          ./package/build-pkg.sh --platform debian --arch amd64 --with-ui --static

      - name: Rename and prepare deb package
        run: |
          cd smartdns
          # 查找生成的deb包
          DEB_FILE=$(find . -name "*.deb" | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "No deb package found!"
            exit 1
          fi
          
          # 获取当前日期时间
          CURRENT_DATE=$(date '+%Y.%m.%d-%H%M')
          
          # 重命名deb包
          NEW_FILENAME="smartdns.1.$CURRENT_DATE.x86_64-debian-all.deb"
          mv "$DEB_FILE" "../$NEW_FILENAME"
          
          echo "Package renamed to: $NEW_FILENAME"

      - name: Push to Releases branch
        run: |
          # 配置git用户
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 切换到Releases分支或创建它
          git checkout Releases 2>/dev/null || git checkout -b Releases
          
          # 如果分支已存在，先拉取远程更改
          if git branch -r | grep -q "origin/Releases"; then
            git pull origin Releases --rebase || echo "Pull failed, continuing with local changes"
          fi
          
          # 清理Releases分支，只保留deb包
          git rm -rf --ignore-unmatch . 2>/dev/null || true
          
          # 复制新的deb包到当前目录
          DEB_FILE=$(find .. -name "smartdns.1.*.x86_64-debian-all.deb" | head -n 1)
          if [ -n "$DEB_FILE" ]; then
            cp "$DEB_FILE" .
            git add *.deb
          else
            echo "No deb package found to upload!"
            exit 1
          fi
          
          # 检查是否有更改需要提交
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update SmartDNS Debian package $(date '+%Y-%m-%d %H:%M:%S')"
            # 使用强制推送以确保成功
            git push origin Releases --force
          fi

      - name: Clean up
        run: |
          rm -rf smartdns
